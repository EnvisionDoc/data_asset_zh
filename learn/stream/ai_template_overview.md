# AI数据聚合处理模板

AI（Analogy Input）即模拟量输入，模拟量输入的物理量有温度、压力、流量等。这些物理量由相应的传感器感应测得，往往经过变送器转变为电信号送入控制器的模拟输入口。针对这类上传数据，EnOS流式计算系统提供统一的AI数据聚合处理模板，能将某一设备上的某个AI测点数据进行聚合处理后赋值给同设备上的另一个AI测点。帮助开发者方便、快速地完成对AI实时数据的处理。

## 性能优势

- 支持基于事件时间的AI数据聚合处理。
- 丰富的聚合算法，包括求最大值（max）、求最小值（min）、求平均值（avg）、求和（sum）、计数（cnt）。
- 支持时间窗口延迟设置，当设置窗口延时后，能支持中间结果的输出（当下一个时间窗口产生时，上一个时间窗口会输出一个中间结果），此中间结果会输出TSDB，但不会归档。
- 支持多样化阈值区间设置，并对超出阈值的异常数据进行插补处理。

## AI数据聚合流任务配置

EnOS系统对所有资产上送的数据都可以使用聚合模板进行归一化处理，所以流式计算系统可对同一资产模型的资产数据采用相同的处理策略。每条策略都包含输入点、输出点、阈值限定、插补策略、窗口大小、聚合算法。

 + **输入点**：输入点是指需要进行处理的资产某个测点数据。

    > AI数据聚合模板只能处理测点类型为AI的测点数据。

 + **输出点**：当每一次对输入点进行处理后，可将处理结果输出至某一个输出点上，并产生一条输出记录。输出记录的时间戳是每个时间窗口的起始时间，输出记录的值对应输入点的值的聚合结果。

   > 1. 输出点必须为AI类型的测点；
   > 2. 为保证任务的正确运行，请保证输入点和输出点属于同一个模型；
   > 3. 要避免在整个流式计算系统中出现环状设计，比如 a -> b -> c -> a。

 + **阈值限定**：输入点在进行处理前可对输入点进行阈值限制，超出阈值的数据可使用插补策略进行订正。

    > 当输入点为非原始点，且插补策略为 “Abandon” 时，阈值范围将不起作用。

 + **插补策略**：插补策略可在处理输入点之前，对其进行订正。目前插补策略只支持丢弃，即超出阈值范围的数据直接不参与后续的聚合处理。

 + **窗口大小**：在流式计算系统中，可设置窗口大小来包含一次窗口分析中需要处理的数据。

   > 当出现 a -> b -> c 这种连续聚合处理时，由于有窗口延时时，a -> b 会输出中间结果（当下个时间窗口产生时，上一个时间窗口会输出一个中间值），b -> c 的窗口大小应尽量与 a -> b 保持一致。

 + **聚合算法**：每个窗口都有一个分析函数，该函数将包含要应用于窗口数据的计算。目前EnOS流式计算系统支持的AI聚合函数包括：max、min、avg、sum、cnt。

   -  max: 比较同一个时间窗口内的所有有效记录的值，将最大值作为输出记录的值
   -  min: 比较同一个时间窗口内的所有有效记录的值，将最小值作为输出记录的值
   -  avg: 对同一个时间窗口内的所有有效记录的值求平均，将平均值作为输出记录的值
   -  sum: 对同一个时间窗口内的所有有效记录的值求和，将求和结果作为输出记录的值
   -  cnt: 对同一个时间窗口内的所有有效记录求计数，将计数结果作为输出记录的值

### 处理策略操作

流任务的设计支持处理策略的添加、复制、编辑和删除等常规动作。

- **添加**：点击新增按钮，可在策略列表上新增一条记录，只有记录的每一项都完成了配置才能进行保存。
- **复制**：当新纪录与某条记录的配置项出现类似时，可复制记录并修改不同项来进行快速配置。
- **编辑**：每一条记录都可随时编辑。
- **删除**：每一条记录都可随时删除。
